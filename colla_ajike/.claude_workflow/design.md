# アンケート機能 - 設計書

## 現状分析

### 既存実装の確認
- **SurveyHandler.ts**: 包括的なSlackインタラクション処理（1035行）
- **SurveyService.ts**: コアビジネスロジック実装済み（358行）
- **サポートクラス**: SurveyBuilder, ResponseCollector実装済み
- **データモデル**: Survey, SurveyResponseテーブル完備

### 実装完了度: 約85%
- ✅ データ永続化層: 完全実装
- ✅ ビジネスロジック層: 完全実装  
- ✅ UI/UX層: 完全実装
- ❌ テンプレート機能: 部分実装
- ❌ 結果可視化: 改善必要

## アーキテクチャ設計

### レイヤー構成
```
┌─────────────────┐
│ Slack UI Layer  │ (SurveyHandler.ts) ✅ 完全実装
├─────────────────┤
│ Business Logic  │ (SurveyService.ts) ✅ 完全実装
├─────────────────┤  
│ Repository      │ (SurveyRepository) ✅ 完全実装
├─────────────────┤
│ Database        │ (Supabase) ✅ 完全実装
└─────────────────┘
```

### コンポーネント間インターフェース

#### 1. SurveyHandler (UI Layer)
**責任**: Slackイベント処理、ユーザーインタラクション
**主要メソッド**:
- `/survey` コマンド処理 ✅
- アンケート作成モーダル ✅
- テンプレート選択 ✅
- 回答収集UI ✅
- 結果表示 ✅

#### 2. SurveyService (Business Logic)
**責任**: アンケートライフサイクル管理
**主要メソッド**:
- `createSurvey()` ✅
- `createSurveyFromTemplate()` ✅
- `submitSurveyResponse()` ✅
- `getSurveyResults()` ✅

#### 3. SurveyBuilder (Support Service)
**責任**: アンケート構造構築とテンプレート管理
**改善必要箇所**:
- テンプレート定義の拡充
- 質問タイプの追加

## 詳細設計

### テンプレート機能強化

#### テンプレートカテゴリー定義
```typescript
const SURVEY_TEMPLATES = {
  hr: {
    name: '人事・組織',
    templates: [
      'employee_satisfaction', // 従業員満足度
      'performance_review',    // 人事評価
      'exit_interview'         // 退職面談
    ]
  },
  project: {
    name: 'プロジェクト',
    templates: [
      'project_retrospective', // プロジェクト振り返り
      'stakeholder_feedback',  // ステークホルダーフィードバック
      'milestone_review'       // マイルストーン評価
    ]
  },
  training: {
    name: '研修・教育',
    templates: [
      'training_effectiveness', // 研修効果測定
      'skill_assessment',       // スキル評価
      'learning_needs'          // 学習ニーズ調査
    ]
  }
};
```

### 結果可視化機能設計

#### データ表示形式
1. **選択式質問**: 
   - 円グラフ相当のテキスト表示
   - パーセンテージと実数の併記

2. **評価スケール**:
   - 平均値とヒストグラム相当の表示
   - 星評価の視覚的表現

3. **自由記述**:
   - 要約表示（最初の3件）
   - キーワード頻度分析（将来機能）

### セキュリティ設計

#### アクセス制御
- **作成権限**: 全ユーザー（組織内のみ）
- **回答権限**: 配信チャンネルメンバーのみ
- **結果閲覧**: 作成者のみ

#### データ保護
- **匿名化オプション**: `anonymous: boolean`フラグ
- **データ保持**: 2年間の自動削除設定
- **暗号化**: Supabase標準暗号化に依存

## UI/UX 設計

### コマンド体系（既存実装済み）
```
/survey              # アンケート一覧
/survey create       # 新規作成
/survey templates    # テンプレート一覧  
/survey my          # 自分の作成分
/survey stats [id]  # 統計表示
/survey remind [id] # リマインダー
```

### モーダル設計（既存実装済み）
1. **作成モーダル**: タイトル、説明、チャンネル選択
2. **テンプレート選択**: カテゴリー別表示
3. **回答モーダル**: 動的質問フォーム
4. **結果表示**: Slackメッセージ形式

## 実装優先順位

### Phase 1: 完成度向上（今回実装）
1. **テンプレート拡充**: 15個の実用テンプレート追加
2. **結果表示改善**: フォーマット最適化
3. **エラーハンドリング強化**: より詳細なエラーメッセージ
4. **バリデーション強化**: 入力値検証の改善

### Phase 2: 機能拡張（将来）
1. **高度な可視化**: グラフィカル表示
2. **AIテキスト分析**: 自由記述の要約機能
3. **エクスポート機能**: CSV/PDF出力
4. **スケジュール配信**: 定期アンケート機能

## パフォーマンス設計

### レスポンス時間目標
- アンケート作成: 2秒以内
- 回答送信: 1秒以内
- 結果表示: 3秒以内

### スケーラビリティ
- 同時回答者: 100名まで対応
- アンケート数: 1チャンネルあたり5個まで同時実行
- データサイズ: 1回答あたり最大10KB

## エラーハンドリング設計

### エラー分類と対応
1. **バリデーションエラー**: フォームエラー表示
2. **権限エラー**: 適切な権限不足メッセージ
3. **ネットワークエラー**: リトライ提案
4. **データ不整合**: 管理者通知

### ログ設計
- **操作ログ**: 全ユーザーアクション記録
- **エラーログ**: 詳細なスタックトレース
- **パフォーマンスログ**: レスポンス時間監視

## テスト戦略

### ユニットテスト（Phase 2）
- SurveyService全メソッドのテスト
- バリデーション機能のテスト
- テンプレート機能のテスト

### 統合テスト（Phase 2）
- Slackモーダル操作のE2Eテスト
- データベース操作の統合テスト
- エラー処理の統合テスト