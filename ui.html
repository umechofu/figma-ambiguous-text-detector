<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>æ›–æ˜§ãƒ†ã‚­ã‚¹ãƒˆæ¤œå‡ºå™¨</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      line-height: 1.4;
      color: #333;
      background: #fff;
      padding: 16px;
    }

    .header {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e5e5;
    }

    .header h1 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .header p {
      color: #666;
      font-size: 11px;
    }

    .scan-section {
      margin-bottom: 20px;
    }

    .scan-button {
      width: 100%;
      padding: 12px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .scan-button:hover {
      background: #0d8ce8;
    }

    .scan-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #f0f0f0;
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
      display: none;
    }

    .progress-fill {
      height: 100%;
      background: #18a0fb;
      width: 0%;
      transition: width 0.3s ease;
    }

    .status-message {
      margin-top: 8px;
      font-size: 11px;
      color: #666;
      text-align: center;
    }

    .results-section {
      margin-top: 20px;
    }

    .results-header {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .results-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .result-item {
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      margin-bottom: 8px;
      padding: 12px;
      background: #fafafa;
    }

    .result-original {
      font-weight: 500;
      margin-bottom: 6px;
      color: #333;
    }

    .result-location {
      font-size: 10px;
      color: #666;
      margin-bottom: 8px;
    }

    .suggestions {
      margin-top: 8px;
    }

    .suggestion-item {
      display: block;
      width: 100%;
      padding: 6px 8px;
      margin-bottom: 4px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }

    .suggestion-item:hover {
      background: #f0f8ff;
      border-color: #18a0fb;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 11px;
    }

    .error-message {
      background: #ffe6e6;
      color: #d63031;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 11px;
      margin-top: 8px;
      display: none;
    }

    .context-preview {
      color: #888;
      font-weight: normal;
      font-size: 10px;
    }

    .navigate-btn {
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 2px 6px;
      font-size: 9px;
      cursor: pointer;
      margin-left: 8px;
    }

    .navigate-btn:hover {
      background: #e0e0e0;
    }

    .original-text {
      margin: 6px 0;
      color: #777;
    }

    .suggestions-label {
      font-size: 10px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #555;
    }

    .suggestion-text {
      flex: 1;
    }

    .confidence {
      font-size: 9px;
      color: #666;
      background: #f0f0f0;
      padding: 1px 4px;
      border-radius: 2px;
      margin-left: 8px;
    }

    .suggestion-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .scan-options {
      margin-bottom: 12px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 11px;
      color: #666;
    }

    .checkbox {
      margin-right: 6px;
      cursor: pointer;
    }

    .checkbox-text {
      user-select: none;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>æ›–æ˜§ãƒ†ã‚­ã‚¹ãƒˆæ¤œå‡ºå™¨</h1>
    <p>UIãƒ†ã‚­ã‚¹ãƒˆã®ã€Œã“ã‚Œã€ã€Œãã‚Œã€ãªã©ã‚’å…·ä½“çš„ãªè¡¨ç¾ã«ç½®ãæ›ãˆã¾ã™</p>
  </div>

  <div class="scan-section">
    <div class="scan-options">
      <label class="checkbox-label">
        <input type="checkbox" id="scanAllPages" class="checkbox">
        <span class="checkbox-text">å…¨ãƒšãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒ£ãƒ³</span>
      </label>
    </div>
    <button id="scanButton" class="scan-button">
      ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã‚¹ã‚­ãƒ£ãƒ³
    </button>
    <div id="progressBar" class="progress-bar">
      <div id="progressFill" class="progress-fill"></div>
    </div>
    <div id="statusMessage" class="status-message"></div>
    <div id="errorMessage" class="error-message"></div>
  </div>

  <div class="results-section">
    <div id="resultsHeader" class="results-header" style="display: none;">
      æ¤œå‡ºçµæœ (<span id="resultCount">0</span>ä»¶)
    </div>
    <div id="resultsList" class="results-list">
      <div id="emptyState" class="empty-state">
        ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ‡ã‚¶ã‚¤ãƒ³å†…ã®æ›–æ˜§ãªãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œå‡ºã—ã¦ãã ã•ã„
      </div>
    </div>
  </div>

  <script>
    // UIè¦ç´ ã®å–å¾—
    const scanButton = document.getElementById('scanButton');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const statusMessage = document.getElementById('statusMessage');
    const errorMessage = document.getElementById('errorMessage');
    const resultsHeader = document.getElementById('resultsHeader');
    const resultsList = document.getElementById('resultsList');
    const resultCount = document.getElementById('resultCount');
    const emptyState = document.getElementById('emptyState');

    // ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    scanButton.addEventListener('click', () => {
      startScan();
    });

    // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
    function startScan() {
      scanButton.disabled = true;
      scanButton.textContent = 'ã‚¹ã‚­ãƒ£ãƒ³ä¸­...';
      progressBar.style.display = 'block';
      statusMessage.textContent = 'ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è§£æã—ã¦ã„ã¾ã™...';
      hideError();

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å–å¾—
      const scanAllPages = document.getElementById('scanAllPages').checked;

      // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã‚¹ã‚­ãƒ£ãƒ³è¦æ±‚ã‚’é€ä¿¡
      parent.postMessage({
        pluginMessage: {
          type: 'scan-document',
          scanAllPages: scanAllPages
        }
      }, '*');
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }

    // ã‚¨ãƒ©ãƒ¼éè¡¨ç¤º
    function hideError() {
      errorMessage.style.display = 'none';
    }

    // çµæœè¡¨ç¤º
    function displayResults(results) {
      if (results.length === 0) {
        resultsList.innerHTML = '<div class="empty-state">æ›–æ˜§ãªãƒ†ã‚­ã‚¹ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        resultsHeader.style.display = 'none';
        return;
      }

      resultsHeader.style.display = 'block';
      resultCount.textContent = results.length;

      const resultsHTML = results.map(result => `
        <div class="result-item" data-result-id="${result.id}">
          <div class="result-original">
            <strong>æ¤œå‡º:</strong> "${result.ambiguousMatch.ambiguousWord}" 
            <span class="context-preview">ï¼ˆ${result.ambiguousMatch.context}ï¼‰</span>
          </div>
          <div class="result-location">
            ğŸ“ ${result.location.pageName} > ${result.location.layerName}
            <button class="navigate-btn" onclick="navigateToNode('${result.nodeId}')">ç§»å‹•</button>
          </div>
          <div class="original-text">
            <small>å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ: "${result.originalText}"</small>
          </div>
          <div class="suggestions">
            <div class="suggestions-label">ç½®æ›å€™è£œ:</div>
            ${result.suggestions.map((suggestion, index) => `
              <button class="suggestion-item" onclick="applySuggestion('${result.nodeId}', '${suggestion.replacementText}', '${result.id}')">
                <span class="suggestion-text">${suggestion.replacementText}</span>
                <span class="confidence">${Math.round(suggestion.confidence * 100)}%</span>
              </button>
            `).join('')}
          </div>
        </div>
      `).join('');

      resultsList.innerHTML = resultsHTML;
    }

    // ç½®æ›å€™è£œã®é©ç”¨
    function applySuggestion(nodeId, newText, resultId) {
      parent.postMessage({
        pluginMessage: {
          type: 'replace-text',
          nodeId: nodeId,
          newText: newText,
          resultId: resultId
        }
      }, '*');

      // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      const resultItem = document.querySelector(`[data-result-id="${resultId}"]`);
      if (resultItem) {
        resultItem.style.opacity = '0.6';
        resultItem.style.background = '#e8f5e8';
      }
    }

    // ãƒãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    function navigateToNode(nodeId) {
      parent.postMessage({
        pluginMessage: {
          type: 'navigate-to-node',
          nodeId: nodeId
        }
      }, '*');
    }

    // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;

      switch (msg.type) {
        case 'scan-started':
          statusMessage.textContent = msg.message;
          break;

        case 'scan-completed':
          scanButton.disabled = false;
          scanButton.textContent = 'ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã‚¹ã‚­ãƒ£ãƒ³';
          progressBar.style.display = 'none';
          statusMessage.textContent = '';
          displayResults(msg.results);
          break;

        case 'replacement-completed':
          statusMessage.textContent = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’ç½®æ›ã—ã¾ã—ãŸ';
          setTimeout(() => {
            statusMessage.textContent = '';
          }, 2000);
          break;

        case 'error':
          scanButton.disabled = false;
          scanButton.textContent = 'ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã‚¹ã‚­ãƒ£ãƒ³';
          progressBar.style.display = 'none';
          statusMessage.textContent = '';
          showError(msg.message);
          break;
      }
    };
  </script>
</body>

</html>